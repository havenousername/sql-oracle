CREATE OR REPLACE PROCEDURE rich_descendant IS
    cnt INTEGER(4) := 0;
BEGIN
    FOR rec_row in (SELECT name, money from NIKOVITS.PARENTOF) LOOP
        SELECT count(*) 
        into cnt 
        from NIKOVITS.PARENTOF
        where money > rec_row.money
        start with name  = rec_row.name
        connect by prior name = parent
        ;
        
        if cnt > 0 then 
            dbms_output.put_line(rec_row.name || '-' || rec_row.money || '-' || cnt);
        end if;
    END LOOP;
END;
/

CREATE OR REPLACE PROCEDURE rich_descendant_average IS
avg_money INTEGER(6);
BEGIN
    FOR rec_row in (SELECT NAME, money from NIKOVITS.PARENTOF) LOOP
        SELECT avg(money) 
        into avg_money 
        from nikovits.parentof 
        start with name = rec_row.name
        connect by prior name = parent;
        
        if avg_money > rec_row.money then
         dbms_output.put_line(rec_row.name || '-' || rec_row.money || '-' || avg_money);
        end if;
    END LOOP;
END;
/

CREATE OR REPLACE PROCEDURE find_cycle(p_node VARCHAR2) IS
BEGIN
    FOR rec_row IN 
    (
        select SYS_CONNECT_BY_PATH(orig, '-') || '-' || dest as route
        from NIKOVITS.FLIGHT 
        start with orig = p_node
        connect by prior dest = orig
    ) LOOP
        dmbs_output.put_line(rec_row.route);
    END LOOP;
END;
/

set serveroutput on;
execute rich_descendant();

set serveroutput on;
execute rich_descendant_average();

select * from nikovits.parentof;
select * from nikovits.flight;